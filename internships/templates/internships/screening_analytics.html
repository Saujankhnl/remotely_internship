{% extends 'base.html' %}
{% block title %}<title>Screening Analytics - {{ job.title }} - Remotely</title>{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="{% url 'internships:view_job_applications' job.pk %}" class="flex items-center gap-2 text-gray-300 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Back to Applications
            </a>
            <div class="flex items-center gap-3">
                <a href="{% url 'internships:accepted_candidates' job.pk %}" class="text-green-400 hover:text-green-300 text-sm">Accepted</a>
                <a href="{% url 'internships:rejected_candidates' job.pk %}" class="text-red-400 hover:text-red-300 text-sm">Rejected</a>
                <a href="{% url 'internships:ranked_applicants' job.pk %}" class="text-yellow-400 hover:text-yellow-300 text-sm">Rankings</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-white">Screening Analytics</h1>
            <p class="text-gray-400">{{ job.title }} &middot; {{ total_applications }} total applications</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-5 text-center">
                <p class="text-3xl font-bold text-white">{{ total_applications }}</p>
                <p class="text-gray-500 text-sm">Total Applications</p>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-5 text-center">
                <p class="text-3xl font-bold text-indigo-400">{{ avg_score }}%</p>
                <p class="text-gray-500 text-sm">Avg Match Score</p>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-5 text-center">
                <p class="text-3xl font-bold text-green-400">{{ status_dist.Accepted|default:"0" }}</p>
                <p class="text-gray-500 text-sm">Accepted</p>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-5 text-center">
                <p class="text-3xl font-bold text-red-400">{{ status_dist.Rejected|default:"0" }}</p>
                <p class="text-gray-500 text-sm">Rejected</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Status Distribution Chart -->
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Application Status Distribution</h3>
                <canvas id="statusChart" height="250"></canvas>
            </div>

            <!-- Score Distribution Chart -->
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Match Score Distribution</h3>
                <canvas id="scoreChart" height="250"></canvas>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Rejection Breakdown Chart -->
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Rejection Reason Breakdown</h3>
                {% if rejection_breakdown %}
                <canvas id="rejectionChart" height="300"></canvas>
                {% else %}
                <p class="text-gray-500 text-center py-8">No rejection data yet</p>
                {% endif %}
            </div>

            <!-- Acceptance Breakdown Chart -->
            <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Acceptance Reason Breakdown</h3>
                {% if acceptance_breakdown %}
                <canvas id="acceptanceChart" height="300"></canvas>
                {% else %}
                <p class="text-gray-500 text-center py-8">No acceptance data yet</p>
                {% endif %}
            </div>
        </div>

        <!-- Top Candidates Table -->
        {% if top_candidates %}
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
            <h3 class="text-lg font-bold text-white mb-4">Top Candidates by Match Score</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-gray-500 text-xs uppercase tracking-wider border-b border-gray-700">
                            <th class="py-3 text-left">Rank</th>
                            <th class="py-3 text-left">Name</th>
                            <th class="py-3 text-left">Email</th>
                            <th class="py-3 text-center">Match Score</th>
                            <th class="py-3 text-center">Status</th>
                            <th class="py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in top_candidates %}
                        <tr class="border-b border-gray-700 hover:bg-gray-700 hover:bg-opacity-50">
                            <td class="py-3 text-gray-400">#{{ forloop.counter }}</td>
                            <td class="py-3 text-white font-medium">{{ app.full_name }}</td>
                            <td class="py-3 text-gray-400">{{ app.email }}</td>
                            <td class="py-3 text-center">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold
                                    {% if app.match_score >= 70 %}bg-green-900 text-green-300
                                    {% elif app.match_score >= 40 %}bg-yellow-900 text-yellow-300
                                    {% else %}bg-red-900 text-red-300{% endif %}">
                                    {{ app.match_score }}%
                                </span>
                            </td>
                            <td class="py-3 text-center">
                                <span class="px-2 py-1 rounded-full text-xs
                                    {% if app.status == 'accepted' %}bg-green-900 text-green-300
                                    {% elif app.status == 'rejected' %}bg-red-900 text-red-300
                                    {% elif app.status == 'shortlisted' %}bg-yellow-900 text-yellow-300
                                    {% elif app.status == 'on_hold' %}bg-orange-900 text-orange-300
                                    {% else %}bg-gray-600 text-gray-300{% endif %}">
                                    {{ app.get_status_display }}
                                </span>
                            </td>
                            <td class="py-3 text-right">
                                <a href="{% url 'internships:job_application_detail' app.pk %}" class="text-indigo-400 hover:text-indigo-300 text-sm">View &rarr;</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    Chart.defaults.color = '#9CA3AF';
    Chart.defaults.borderColor = '#374151';

    // Status Distribution
    const statusData = {{ status_dist_json|safe }};
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: ['#6B7280','#3B82F6','#EAB308','#F97316','#8B5CF6','#EF4444','#10B981'],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
            }
        }
    });

    // Score Distribution
    const scoreData = {{ score_buckets_json|safe }};
    new Chart(document.getElementById('scoreChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(scoreData),
            datasets: [{
                label: 'Applicants',
                data: Object.values(scoreData),
                backgroundColor: ['#EF4444','#F97316','#EAB308','#10B981','#3B82F6'],
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });

    {% if rejection_breakdown %}
    const rejData = {{ rejection_breakdown_json|safe }};
    new Chart(document.getElementById('rejectionChart'), {
        type: 'horizontalBar' in Chart ? 'horizontalBar' : 'bar',
        data: {
            labels: Object.keys(rejData),
            datasets: [{
                label: 'Count',
                data: Object.values(rejData),
                backgroundColor: '#EF4444',
                borderRadius: 6,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } },
                y: { grid: { display: false } }
            }
        }
    });
    {% endif %}

    {% if acceptance_breakdown %}
    const accData = {{ acceptance_breakdown_json|safe }};
    new Chart(document.getElementById('acceptanceChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(accData),
            datasets: [{
                label: 'Count',
                data: Object.values(accData),
                backgroundColor: '#10B981',
                borderRadius: 6,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } },
                y: { grid: { display: false } }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
